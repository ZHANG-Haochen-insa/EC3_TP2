# XDC约束文件使用说明

## 📁 文件位置

- **Q1**: `Q1_Validation_Basique/digicode_q1.xdc`
- **Q2**: `Q2_Modification_Code/digicode_q2.xdc`

---

## 📌 引脚分配总览

### 通用引脚（Q1和Q2都使用）

| 信号名称 | VHDL端口 | FPGA引脚 | 功能说明 |
|---------|---------|---------|---------|
| **时钟** | CLK100MHZ | E3 | 100MHz系统时钟 |
| **复位** | CPU_RESETN | N17 | BTNC中央按钮（高电平有效） |

### 按钮输入（密码输入）

| 信号名称 | VHDL端口 | FPGA引脚 | 密码编码 | 说明 |
|---------|---------|---------|---------|------|
| 下按钮 | BTND | P18 | 0001 | 第1位密码（默认） |
| 右按钮 | BTNR | M17 | 0010 | 第2位密码（默认） |
| 上按钮 | BTNU | M18 | 0100 | 第3位密码（默认） |
| 左按钮 | BTNL | P17 | 1000 | 第4位密码（默认） |

### LED输出

| 信号名称 | VHDL端口 | FPGA引脚 | Q1使用 | Q2使用 | 功能说明 |
|---------|---------|---------|--------|--------|---------|
| LED0 | LED0 | H17 | ✅ | ✅ | 地址位0（显示当前验证第几位） |
| LED1 | LED1 | K15 | ✅ | ✅ | 地址位1 |
| LED2 | LED2 | J13 | ✅ | ✅ | 门锁状态（1=开，0=关） |
| LED3 | LED3 | N14 | ❌ | ✅ | 修改模式指示灯 |

### 开关输入

| 信号名称 | VHDL端口 | FPGA引脚 | Q1使用 | Q2使用 | 功能说明 |
|---------|---------|---------|--------|--------|---------|
| SW0 | SW0 | J15 | ✅ | ✅ | 门的物理状态（0=关，1=开） |
| SW1 | SW1 | L16 | ❌ | ✅ | 密码修改模式开关 |

---

## 🔧 在Vivado中使用XDC文件

### 方法1：创建新项目时添加

1. 在Vivado中创建新项目
2. 添加设计源文件（.vhd）
3. 在"Add Constraints"步骤时，添加对应的XDC文件
   - Q1项目使用 `digicode_q1.xdc`
   - Q2项目使用 `digicode_q2.xdc`

### 方法2：在现有项目中添加

1. 在Vivado的"Sources"窗口
2. 右键点击"Constraints" → "Add Sources"
3. 选择"Add or create constraints"
4. 点击"Add Files"，选择对应的XDC文件
5. 点击"Finish"

### 方法3：直接复制

将XDC文件复制到项目的约束文件夹，然后在Vivado中刷新。

---

## 📊 LED地址指示说明

LED0和LED1组合显示当前正在验证的密码位：

| LED1 | LED0 | 二进制 | 十进制 | 验证位置 |
|------|------|--------|--------|----------|
| 0 | 0 | 00 | 0 | 第1位密码 |
| 0 | 1 | 01 | 1 | 第2位密码 |
| 1 | 0 | 10 | 2 | 第3位密码 |
| 1 | 1 | 11 | 3 | 第4位密码 |

---

## 🎮 Nexys A7板上的物理位置

### 按钮位置（板子中央）
```
        [BTNU]
          ↑
[BTNL] ← [BTNC] → [BTNR]
          ↓
        [BTND]
```

- **BTNC**: 复位按钮（中央）
- **BTND, BTNR, BTNU, BTNL**: 密码输入按钮

### 开关位置（板子右下角）
```
SW15 SW14 ... SW2 SW1 SW0
[  ] [  ]     [ ] [ ] [ ]
```

### LED位置（板子底部中央）
```
LED15 ... LED3 LED2 LED1 LED0
 [ ]       [●]  [●]  [●]  [●]
```

---

## ⚡ 电气特性

- **I/O标准**: LVCMOS33（3.3V逻辑电平）
- **时钟频率**: 100MHz
- **时钟周期**: 10ns
- **按钮类型**: 按下时为高电平（内部有上拉电阻）
- **LED驱动**: 高电平点亮

---

## 🧪 功能测试

### Q1测试步骤

1. **复位系统**
   - 按下BTNC（中央按钮）
   - 所有LED应该熄灭（或显示初始状态）

2. **输入默认密码**
   - 按下BTND → 观察LED0、LED1变化
   - 按下BTNR → 观察LED0、LED1变化
   - 按下BTNU → 观察LED0、LED1变化
   - 按下BTNL → 观察LED0、LED1变化

3. **验证成功**
   - LED2应该点亮（门锁打开）

4. **模拟开门/关门**
   - 将SW0拨到上方（1）：模拟推开门
   - 将SW0拨回下方（0）：模拟关门
   - LED2应该熄灭，系统返回初始状态

### Q2额外测试（在Q1基础上）

1. **进入修改模式**
   - 先输入正确密码（门打开，LED2亮）
   - 将SW1拨到上方（1）
   - LED3应该点亮（表示进入修改模式）

2. **输入新密码**
   - 依次按下4个按钮设置新密码
   - LED3保持点亮

3. **退出修改模式**
   - 将SW1拨回下方（0）
   - LED3熄灭
   - 将SW0拨回下方（0）关门

4. **验证新密码**
   - 尝试使用新密码开门
   - 应该成功（LED2亮）
   - 旧密码应该失效

---

## 🔍 故障排查

### 问题1：综合时出现"未约束的I/O"警告

**原因**: XDC文件中的端口名称与VHDL代码中的端口名称不匹配

**解决**:
1. 检查XDC文件中的端口名称
2. 确保与顶层VHDL文件（digicode.vhd）中的端口完全一致
3. 注意大小写

### 问题2：实现后时序不满足

**原因**: 时钟约束可能有问题

**解决**:
1. 检查create_clock约束是否正确
2. 查看Timing Report
3. 考虑降低时钟分频后的频率要求

### 问题3：LED不亮或按钮无响应

**可能原因**:
1. FPGA未正确烧录
2. 引脚分配错误
3. Reset极性问题

**解决**:
1. 重新生成比特流并烧录
2. 检查XDC文件引脚是否正确
3. 检查代码中的reset逻辑（当前使用高电平有效）

### 问题4：按钮去抖动问题

**现象**: 一次按键触发多次

**解决**:
1. 检查div_horloge的分频比
2. 确保时钟足够慢（约3Hz）
3. 检查状态机的释放检测逻辑

---

## 📝 自定义引脚

如果需要使用其他LED或开关，可以修改XDC文件：

### Nexys A7常用引脚参考

**LED（16个）**:
```
LED0: H17    LED4: N16    LED8: T10    LED12: P14
LED1: K15    LED5: R18    LED9: T11    LED13: T15
LED2: J13    LED6: V17    LED10: T12   LED14: L14
LED3: N14    LED7: U17    LED11: T14   LED15: K16
```

**开关（16个）**:
```
SW0: J15     SW4: L13     SW8: R13     SW12: U11
SW1: L16     SW5: M13     SW9: T8      SW13: V10
SW2: M13     SW6: R15     SW10: U8     SW14: V11
SW3: R17     SW7: R17     SW11: R16    SW15: V12
```

### 修改步骤

1. 在XDC文件中找到要修改的引脚行
2. 修改PACKAGE_PIN后面的引脚编号
3. 保存XDC文件
4. 在Vivado中重新运行实现

**示例**:
```tcl
## 原来使用LED0 (H17)
set_property -dict { PACKAGE_PIN H17   IOSTANDARD LVCMOS33 } [get_ports { LED0 }];

## 改为使用LED15 (K16)
set_property -dict { PACKAGE_PIN K16   IOSTANDARD LVCMOS33 } [get_ports { LED0 }];
```

---

## ⚠️ 重要注意事项

1. **端口名称必须匹配**
   - XDC中的端口名称必须与VHDL顶层模块完全一致
   - 区分大小写

2. **不要混用Q1和Q2的XDC**
   - Q1只有3个LED，使用digicode_q1.xdc
   - Q2有4个LED和2个开关，使用digicode_q2.xdc

3. **时钟约束很重要**
   - create_clock约束定义了100MHz时钟
   - 不要删除这一行

4. **Reset极性**
   - 当前设计使用高电平有效复位（无反转）
   - BTNC按下时为高电平，触发复位

5. **所有I/O必须约束**
   - 每个顶层端口都必须在XDC中定义
   - 未约束的端口会导致警告或错误

---

## 📚 参考资料

- Nexys A7参考手册
- Vivado约束文件（XDC）使用指南
- FPGA引脚分配最佳实践

---

## ✅ 检查清单

在综合和实现之前，请确认：

- [ ] 已添加正确的XDC文件（Q1用q1，Q2用q2）
- [ ] XDC中的端口名称与VHDL顶层完全匹配
- [ ] 所有端口都已约束
- [ ] 时钟约束已正确设置
- [ ] I/O标准设置为LVCMOS33
- [ ] 没有未约束的I/O警告

祝综合成功！🎉
