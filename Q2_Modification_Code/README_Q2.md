# Question 2 - Modification du Code

## 📁 描述

本文件夹包含**第二问**所需的所有文件：在第一问基础上增加**密码修改功能**。

## 📋 文件列表

### 核心设计文件

1. **machine_moore.vhd** (即machine_etats) - 完整的Moore状态机
   - 功能：验证密码 + 修改密码
   - 状态数：20个（包含密码修改相关状态）
   - 包含完整的密码修改逻辑

2. **memoire.vhd** - 内存模块
   - 存储4位密码
   - 默认密码：0001, 0010, 0100, 1000（BTND, BTNR, BTNU, BTNL）
   - 支持读写操作

3. **division_horloge.vhd** - 时钟分频器
   - 将100MHz系统时钟分频到约3Hz
   - 便于观察LED变化和按钮检测

4. **digicode_top.vhd** - 顶层模块
   - 连接所有子模块
   - 实例化machine_etats、memoire、division_horloge
   - 映射到FPGA引脚

### 仿真测试文件

5. **machine_etats_tb.vhd** - Testbench
   - 包含7个测试场景
   - 测试密码验证和修改功能
   - 自动验证功能正确性

### 文档文件

6. **README_Q2.md** - 本文件

## 🎯 功能说明

### 第二问要求实现：

✅ 4位密码顺序输入验证（继承Q1）
✅ 正确后LED点亮（模拟开门）
✅ 错误后返回初始状态
✅ 按钮去抖动（等待释放）
✅ 门开关模拟（switch控制）
✅ **密码修改功能**（新增）
✅ **修改模式LED指示**（新增）

### 新增功能详解：

#### 🔑 密码修改流程

1. 输入正确的当前密码 → 门打开
2. 将SW1开关拨到1（进入修改模式）
3. LED3点亮（指示进入修改模式）
4. 按顺序输入4位新密码
5. 新密码自动写入内存
6. 将SW1开关拨回0（退出修改模式）
7. 用新密码验证

## 🔌 端口说明

### 输入端口

| 端口名称 | 类型 | 说明 |
|---------|------|------|
| CLK100MHZ | STD_LOGIC | 系统时钟（100MHz） |
| CPU_RESETN | STD_LOGIC | 复位按钮（高电平有效） |
| BTND | STD_LOGIC | 下按钮（密码位1：0001） |
| BTNR | STD_LOGIC | 右按钮（密码位2：0010） |
| BTNU | STD_LOGIC | 上按钮（密码位3：0100） |
| BTNL | STD_LOGIC | 左按钮（密码位4：1000） |
| SW0 | STD_LOGIC | 开关0（模拟门的物理状态） |
| SW1 | STD_LOGIC | **开关1（激活密码修改模式）** ⭐新增 |

### 输出端口

| 端口名称 | 类型 | 说明 |
|---------|------|------|
| LED0 | STD_LOGIC | 地址位0（显示当前验证第几位） |
| LED1 | STD_LOGIC | 地址位1 |
| LED2 | STD_LOGIC | 门锁状态（1=开，0=关） |
| LED3 | STD_LOGIC | **修改模式指示灯** ⭐新增 |

## 🚀 使用方法

### 1. Vivado综合实现

```bash
# 在Vivado中创建项目
# 添加以下源文件（按顺序）：
1. memoire.vhd
2. division_horloge.vhd
3. machine_moore.vhd
4. digicode_top.vhd  (设为Top Module)

# 添加约束文件（.xdc），确保包含SW1和LED3
# 运行综合（Synthesis）
# 运行实现（Implementation）
# 生成比特流（Generate Bitstream）
# 烧录到FPGA板
```

### 2. GHDL仿真

```bash
# 编译所有文件
ghdl -a memoire.vhd
ghdl -a machine_moore.vhd
ghdl -a machine_etats_tb.vhd

# 生成可执行文件
ghdl -e machine_etats_tb

# 运行仿真
ghdl -r machine_etats_tb --wave=machine_etats_sim.ghw

# 查看波形
gtkwave machine_etats_sim.ghw
```

## 📊 Moore状态机（20个状态）

### 验证模式（9个状态）
```
ST_IDLE        → 等待第1位密码输入
ST_CHECK_1     → 检查第1位
ST_WAIT_REL_1  → 等待释放
ST_CHECK_2     → 检查第2位
ST_WAIT_REL_2  → 等待释放
ST_CHECK_3     → 检查第3位
ST_WAIT_REL_3  → 等待释放
ST_CHECK_4     → 检查第4位
ST_SUCCESS     → 密码正确
ST_FAIL        → 密码错误
ST_OPEN        → 门打开状态
```

### 修改模式（9个状态）⭐新增
```
ST_GOTO_CHANGE      → 准备进入修改模式
ST_CHANGE_MODE      → 修改模式初始状态
ST_WRITE_1          → 写入新密码第1位
ST_WAIT_WRITE_REL_1 → 等待释放
ST_WRITE_2          → 写入新密码第2位
ST_WAIT_WRITE_REL_2 → 等待释放
ST_WRITE_3          → 写入新密码第3位
ST_WAIT_WRITE_REL_3 → 等待释放
ST_WRITE_4          → 写入新密码第4位
ST_WAIT_WRITE_REL_4 → 等待释放并完成
```

## 🧪 测试场景

### Test 1: 复位验证
- 验证系统复位后回到初始状态

### Test 2: 使用默认密码验证
- 输入：0001 → 0010 → 0100 → 1000
- 期望：门打开

### Test 3: 进入修改模式
- 激活SW1开关
- 期望：LED3点亮

### Test 4: 输入新密码
- 输入：1000 → 0100 → 0010 → 0001（反向顺序）
- 新密码写入内存

### Test 5: 旧密码失效测试
- 尝试使用旧密码（0001 → 0010...）
- 期望：失败，门不开

### Test 6: 新密码验证测试
- 使用新密码（1000 → 0100 → 0010 → 0001）
- 期望：成功，门打开

### Test 7: 持久性验证
- 关门后再次使用新密码
- 期望：成功，证明密码已永久保存

## 💡 完整操作流程

### 场景1：正常开门（使用当前密码）

```
1. 按下复位按钮
2. 按顺序输入4位密码
3. 门打开（LED2亮）
4. 将SW0拨到1（推开门）
5. 将SW0拨回0（关门）
6. 系统回到初始状态
```

### 场景2：修改密码

```
1. 按下复位按钮
2. 输入正确的当前密码 → 门打开
3. 将SW1拨到1 → LED3亮（进入修改模式）
4. 按顺序输入4位新密码
5. 等待所有按钮释放
6. 将SW1拨回0 → LED3灭（退出修改模式）
7. 系统自动回到初始状态
8. 现在只能用新密码开门
```

## ⚠️ 重要注意事项

1. **修改密码的前提**：
   - ✅ 必须先输入正确的当前密码（门打开状态）
   - ✅ 然后才能激活SW1进入修改模式
   - ❌ 不能在初始状态或错误状态直接进入修改模式

2. **内存写入**：
   - 新密码会立即写入内存
   - 断电前密码会保持（在仿真中）
   - 实际FPGA板需要考虑断电保持问题

3. **安全性**：
   - 必须知道当前密码才能修改
   - 修改过程中LED3保持点亮
   - 防止误操作

4. **Reset极性**：
   - 当前代码使用高电平有效复位（无反转）

## 🔍 调试建议

### 在仿真中观察的关键信号

1. **状态信号**：
   - `UUT/state` - 当前状态
   - 观察是否正确进入WRITE状态

2. **控制信号**：
   - `modif_code` - 修改模式开关
   - `wen` - 写使能信号（应该在WRITE状态为'1'）
   - `led_chang_code` - LED3状态

3. **数据信号**：
   - `data_mem` - 写入内存的数据
   - `contenu_mem` - 从内存读取的数据
   - `adresse_machine` - 当前访问的内存地址

### 常见问题排查

**问题1：LED3不亮**
- 检查是否成功开门
- 检查SW1是否正确连接
- 检查状态是否进入ST_CHANGE_MODE

**问题2：新密码写入失败**
- 观察`wen`信号是否在WRITE状态为'1'
- 检查`data_mem`是否正确传递按钮值
- 检查内存模块的写逻辑

**问题3：旧密码仍然有效**
- 检查内存写入是否真正执行
- 观察内存内容是否改变
- 确认写地址是否正确

## 📈 与Q1的区别

| 特性 | Q1 | Q2 |
|-----|----|----|
| 状态机 | moore_q1 (9状态) | machine_etats (20状态) |
| 密码修改 | ❌ | ✅ |
| SW1开关 | 不使用 | 修改模式开关 |
| LED3 | 不使用 | 修改模式指示 |
| 内存写入 | 不使用 | 使用wen信号 |
| 复杂度 | 简单 | 复杂 |

## 📖 相关文档

- `../Q1_Validation_Basique/` - 第一问文件（基础版本）
- `TP VHDL Digicode 2025.pdf` - 原始实验指导书

## ✅ 完成检查清单

- [ ] 能使用默认密码开门
- [ ] 能进入修改模式（LED3亮）
- [ ] 能输入并保存新密码
- [ ] 旧密码失效
- [ ] 新密码有效
- [ ] 关门后新密码仍然有效
- [ ] 仿真测试全部通过
- [ ] 在FPGA板上验证成功

祝你成功完成第二问！🎉
